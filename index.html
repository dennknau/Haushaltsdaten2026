<script>
async function loadData() {
    const response = await fetch('haushalt.json');
    const data = await response.json();
    console.log("Beispieldatensatz:", data[0]); // hilft beim Debuggen
    return data;
}

loadData().then(data => {
    // 1. Alle Gruppen (Spalte "gruppe") einsammeln
    const gruppen = [...new Set(data.map(d => d.gruppe))];

    const select = document.getElementById('gruppenFilter');
    gruppen.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g;
        opt.textContent = g;
        select.appendChild(opt);
    });

    // 2. Start: erste Gruppe anzeigen
    drawChartFor(gruppen[0], data);

    // 3. Bei Änderung neu zeichnen
    select.addEventListener('change', () => {
        drawChartFor(select.value, data);
    });
});

// Hilfsfunktion: Betrag aus Datensatz holen und in Zahl umwandeln
function getAmount(d) {
    // Versuche verschiedene mögliche Schlüsselnamen
    let raw =
        d.betrag ??
        d['€ nach HH'] ??
        d['Euro_nach_HH'] ??
        d['Euro'] ??
        null;

    if (raw === null) return 0;

    // In String verwandeln
    raw = String(raw).trim();

    // Euro-Zeichen und Leerzeichen entfernen
    raw = raw.replace('€', '').replace(/\s/g, '');

    // Tausenderpunkte entfernen, Komma in Punkt umwandeln
    raw = raw.replace(/\./g, '').replace(',', '.');

    const num = Number(raw);
    return isNaN(num) ? 0 : num;
}

function drawChartFor(gruppe, data) {
    const ctx = document.getElementById('chart1').getContext('2d');

    const filtered = data.filter(d => d.gruppe === gruppe);

    const labels = filtered.map(d => d.sachkonto || d['SK & Bezeichnung'] || 'ohne Bezeichnung');
    const values = filtered.map(d => getAmount(d));

    console.log("Zeichne für Gruppe:", gruppe, "Anzahl Datensätze:", filtered.length);
    console.log("Beispiele Werte:", values.slice(0, 5));

    if (window.myChart) {
        window.myChart.destroy();
    }

    window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '€ nach HH',
                data: values
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}
</script>
