<script>
async function loadData() {
    const response = await fetch('haushalt.json');
    const data = await response.json();
    console.log("Erster Datensatz:", data[0]); // Debug-Ausgabe
    return data;
}

loadData().then(data => {
    // Alle Gruppen aus der Spalte "gruppe" einsammeln
    const gruppen = [...new Set(data.map(d => d.gruppe))];

    const select = document.getElementById('gruppenFilter');
    gruppen.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g;
        opt.textContent = g;
        select.appendChild(opt);
    });

    // Start: erste Gruppe anzeigen
    drawChartFor(gruppen[0], data);

    // Beim Wechsel neu zeichnen
    select.addEventListener('change', () => {
        drawChartFor(select.value, data);
    });
});

// Betrag (Spalte "betrag") in eine Zahl verwandeln
function parseBetrag(raw) {
    if (raw === null || raw === undefined) return 0;

    raw = String(raw).trim();
    // Eurozeichen & Leerzeichen entfernen
    raw = raw.replace('€', '').replace(/\s/g, '');
    // Tausenderpunkte entfernen, Komma in Punkt umwandeln
    raw = raw.replace(/\./g, '').replace(',', '.');

    const num = Number(raw);
    return isNaN(num) ? 0 : num;
}

function drawChartFor(gruppe, data) {
    const ctx = document.getElementById('chart1').getContext('2d');

    const filtered = data.filter(d => d.gruppe === gruppe);

    const labels = filtered.map(d => d.sachkonto || d['SK & Bezeichnung'] || 'ohne Bezeichnung');
    const values = filtered.map(d => parseBetrag(d.betrag));

    console.log("Zeichne Gruppe:", gruppe, "Anzahl:", filtered.length);
    console.log("Beispielwerte:", values.slice(0, 5));

    if (window.myChart) {
        window.myChart.destroy();
    }

    window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '€ nach HH',
                data: values
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}
</script>
